@page "/battleship"

<div class="battle-container">
    <!-- Animated background particles -->
    <div class="particles-bg">
        @for (int i = 0; i < 30; i++)
        {
            <div class="particle" style="--delay: @(i * 0.15)s; --duration: @(Random.Shared.Next(4, 9))s;"></div>
        }
    </div>

    <div class="battle-content">
        <h3>Battle Phase</h3>

        <div class="boards-container">
    <div class="board-section">
        <table>
            @for (int row = 0; row < 10; row++)
            {
                <tr>
                    @for (int col = 0; col < 10; col++)
                    {
                        int currentRow = row;
                        int currentCol = col;
                        <td class="@GetPlayerCellClass(currentRow, currentCol)">
                            @DisplayPlayerCellContent(currentRow, currentCol)
                        </td>
                    }
                </tr>
            }
        </table>
        <div class="board-label @(isPlayerTurn ? "" : "active-turn")">
            <h3>Your Fleet</h3>
        </div>
    </div>
    
    <div class="board-section">
        <table>
            @for (int row = 0; row < 10; row++)
            {
                <tr>
                    @for (int col = 0; col < 10; col++)
                    {
                        int currentRow = row;
                        int currentCol = col;
                        <td class="@GetOpponentCellClass(currentRow, currentCol)" 
                            @onclick="() => OnOpponentCellClick(currentRow, currentCol)">
                            @DisplayCellContent(opponentGrid, currentRow, currentCol)
                        </td>
                    }
                </tr>
            }
        </table>
        <div class="board-label @(isPlayerTurn ? "active-turn" : "")">
            <h3>Enemy Waters</h3>
        </div>
    </div>
</div>

@if (CheckVictory())
{
    <div class="victory-message">
        <h2>ðŸŽ‰ Victory! You've sunk all enemy ships! ðŸŽ‰</h2>
        <button class="btn btn-primary" @onclick="RestartGame">Play Again</button>
    </div>
}

    </div>
</div>

<style>
    /* Battle Page Background */
    .battle-container {
        min-height: 100vh;
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, #0f3460 0%, #16537e 25%, #2e8b9e 50%, #3ea8a8 75%, #4fc3aa 100%);
        font-family: 'Exo 2', sans-serif;
    }

    /* Animated Background Particles */
    .particles-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }

    .particle {
        position: absolute;
        width: 3px;
        height: 3px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 50%;
        animation: float var(--duration) infinite ease-in-out;
        animation-delay: var(--delay);
        left: calc(var(--delay) * 25);
        top: calc(var(--delay) * 20);
    }

    .battle-content {
        position: relative;
        z-index: 2;
        padding: 2rem;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 2rem;
    }

    h3 {
        color: #ffffff;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        font-family: 'Orbitron', sans-serif;
    }

    .battle-status {
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        color: white;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 600px;
    }

    .status-text {
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .boards-container {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .board-section {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .board-section h3 {
        color: #ffffff;
        margin-top: 15px;
        margin-bottom: 0;
        font-size: 1.5rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .board-label {
        text-align: center;
        margin-top: 20px;
        padding: 20px 30px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        color: white;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
        transition: all 0.3s ease;
    }

    .board-label.active-turn {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        box-shadow: 0 8px 32px rgba(255, 107, 107, 0.4);
        border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .board-label h3 {
        color: #ffffff;
        margin: 0;
        font-size: 1.6rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        font-family: 'Orbitron', sans-serif;
    }

    table {
        border-collapse: collapse;
        margin: 0 auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #333;
    }

    td {
        width: 40px;
        height: 40px;
        border: 1px solid #333;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        font-weight: bold;
        font-size: 18px;
        user-select: none;
        transition: all 0.2s ease;
        border-right: 1px solid #333;
        border-bottom: 1px solid #333;
    }

    /* Remove borders on outer edges to work with table border */
    td:first-child {
        border-left: none;
    }

    td:last-child {
        border-right: none;
    }

    tr:first-child td {
        border-top: none;
    }

    tr:last-child td {
        border-bottom: none;
    }

    .empty {
        background-color: #87CEEB;
    }

    .empty:hover {
        background-color: #B0E0E6;
        transform: scale(1.05);
    }

    .ship {
        background-color: #4169E1;
        color: white;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .hit {
        background-color: #DC143C;
        color: white;
        position: relative;
    }

    .hit::after {
        content: "ðŸ’¥";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
    }

    .miss {
        background-color: #696969;
        color: white;
    }

    .hit, .miss {
        cursor: not-allowed;
    }

    .victory-message {
        text-align: center;
        margin-top: 30px;
        padding: 25px;
        background: rgba(40, 167, 69, 0.2);
        backdrop-filter: blur(10px);
        color: white;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(40, 167, 69, 0.3);
        border: 2px solid rgba(40, 167, 69, 0.4);
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }

    .victory-message h2 {
        margin: 0 0 15px 0;
        font-size: 2rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        font-family: 'Orbitron', sans-serif;
    }

    .btn {
        padding: 12px 24px;
        border: 2px solid #000;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        border: 2px solid #000;
        box-shadow: 0 8px 30px rgba(255, 107, 107, 0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        transform: translateY(-3px);
        box-shadow: 0 12px 40px rgba(255, 107, 107, 0.4);
        border: 2px solid #000;
    }
</style>

@code {
    // 0 = empty, 1 = ship, 2 = hit, 3 = miss
    int[,] opponentGrid = new int[10, 10];
    ShipManager shipManager = new ShipManager();
    private int totalOpponentShips = 0;
    private int hitOpponentShips = 0;
    private bool isPlayerTurn = true; // Player starts first

    protected override void OnInitialized()
    {
        // Place player ships automatically for now (in a real implementation, this would come from ship placement page)
        PlacePlayerShipsAutomatically();
        PlaceOpponentShips();
    }

    void PlacePlayerShipsAutomatically()
    {
        // Auto-place player ships for demonstration
        shipManager.PlaceShip(shipManager.Ships[0], 0, 0, ShipOrientation.Horizontal); // Carrier
        shipManager.PlaceShip(shipManager.Ships[1], 2, 1, ShipOrientation.Vertical);   // Battleship
        shipManager.PlaceShip(shipManager.Ships[2], 5, 5, ShipOrientation.Horizontal); // Cruiser
        shipManager.PlaceShip(shipManager.Ships[3], 8, 8, ShipOrientation.Vertical);   // Submarine
    }

    void PlaceOpponentShips()
    {
        // Place opponent ships randomly (simplified)
        var shipPositions = new List<(int row, int col)>();
        
        // Carrier (3 cells)
        for (int col = 3; col <= 5; col++)
        {
            opponentGrid[2, col] = 1;
            shipPositions.Add((2, col));
        }
        
        // Battleship (3 cells)
        for (int row = 1; row <= 3; row++)
        {
            opponentGrid[row, 7] = 1;
            shipPositions.Add((row, 7));
        }
        
        // Cruiser (3 cells)
        for (int col = 1; col <= 3; col++)
        {
            opponentGrid[5, col] = 1;
            shipPositions.Add((5, col));
        }
        
        // Submarine (2 cells)
        opponentGrid[8, 6] = 1;
        opponentGrid[8, 7] = 1;
        shipPositions.Add((8, 6));
        shipPositions.Add((8, 7));
        
        // Single ship (1 cell)
        opponentGrid[0, 9] = 1;
        shipPositions.Add((0, 9));

        totalOpponentShips = shipPositions.Count;
    }

    void OnOpponentCellClick(int row, int col)
    {
        if (!isPlayerTurn) return; // Not player's turn
        if (row < 0 || row >= 10 || col < 0 || col >= 10)
            return;
        if (opponentGrid[row, col] == 2 || opponentGrid[row, col] == 3)
            return;

        if (opponentGrid[row, col] == 1)
        {
            opponentGrid[row, col] = 2; // hit
            hitOpponentShips++;
        }
        else
        {
            opponentGrid[row, col] = 3; // miss
        }

        // Switch to opponent's turn after any move (hit or miss)
        isPlayerTurn = false;
        
        // Simulate opponent's turn after a short delay
        _ = Task.Delay(1000).ContinueWith(t => {
            InvokeAsync(() => {
                SimulateOpponentTurn();
                isPlayerTurn = true; // Back to player's turn
                StateHasChanged();
            });
        });

        StateHasChanged();
    }

    void SimulateOpponentTurn()
    {
        // Simple AI: randomly attack player's ships
        Random random = new Random();
        int attempts = 0;
        
        while (attempts < 100) // Prevent infinite loop
        {
            int row = random.Next(0, 10);
            int col = random.Next(0, 10);
            
            // Check if this cell hasn't been attacked yet
            if (shipManager.Grid[row, col] != 2 && shipManager.Grid[row, col] != 3)
            {
                if (shipManager.Grid[row, col] == 1)
                {
                    shipManager.Grid[row, col] = 2; // hit
                }
                else
                {
                    shipManager.Grid[row, col] = 3; // miss
                }
                break;
            }
            attempts++;
        }
    }

    bool CheckVictory()
    {
        return hitOpponentShips >= totalOpponentShips;
    }

    void RestartGame()
    {
        // Reset grids
        opponentGrid = new int[10, 10];
        shipManager = new ShipManager();
        hitOpponentShips = 0;
        totalOpponentShips = 0;
        isPlayerTurn = true; // Reset to player's turn
        
        // Reinitialize the game
        OnInitialized();
        StateHasChanged();
    }

    string GetPlayerCellClass(int row, int col)
    {
        if (shipManager.Grid[row, col] == 1)
            return "ship";
        return "empty";
    }

    string GetOpponentCellClass(int row, int col)
    {
        return opponentGrid[row, col] switch
        {
            2 => "hit",
            3 => "miss",
            _ => "empty"
        };
    }

    string DisplayPlayerCellContent(int row, int col)
    {
        var ship = shipManager.GetShipAtPosition(row, col);
        if (ship != null)
        {
            return ship.Type[0].ToString(); // First letter of ship type
        }
        return "";
    }

    string DisplayCellContent(int[,] grid, int row, int col)
    {
        return grid[row, col] switch
        {
            2 => "X", // hit
            3 => "O", // miss
            _ => ""
        };
    }
}
